<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Proud Blog - 「AWS WAF」を導入してみた。- String matching編</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css" rel="stylesheet" /></head><body><header><h1><a href="/">Proud Blog</a></h1><ul class="header-social"><li><a href="https://www.facebook.com/proudit/"><i class="fa fa-facebook-square fa-2x"></i></a></li><li><a href="https://github.com/proudit"><i class="fa fa-github fa-2x"></i></a></li></ul></header><div id="main" role="main"><article><h1>「AWS WAF」を導入してみた。- String matching編</h1><div class="tag-labels"><small class="tag-label">AWS</small><small class="tag-label">WAF</small><small class="tag-label">CloudFront</small></div><br /><p><img class="author" src="/images/authors/kohei.png" /> <i class="fa fa-pencil"></i>Written by    <b>Kohei Yamada</b>　<i class="fa fa-clock-o"></i>Posted on  <b>2016/01/12</b></p><p><div style="width:74px;height:22px;float:left;"><div style="margin-left:-5px"><a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="proudit_inc" data-lang="ja" data-hashtags="proudblog" data-dnt="true">ツイート</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><div style="width:120px;height:22px;float:left;"><iframe src="//www.facebook.com/v2.0/plugins/like.php?href=http%3A%2F%2Fblog.proudit.jp&amp;width&amp;layout=button&amp;action=like&amp;show_faces=false&amp;share=true&amp;height=90&amp;appId=1679223382318515" scrolling="no" frameborder="0" style="border:none; overflow:hidden; height:90px;" allowTransparency="true"></iframe></div></p><hr /><br /><h1 id="はじめに">はじめに</h1>

<hr>

<p>2015年のre:Inventで「AWS WAF」が発表されました。</p>

<p>AWS WAFはアプリケーション用のファイアウォールで、IP address、SQL injection、String matchingに関するアクセスの制御ができます。<br>
ただ、このサービスを利用するにはCloudFront経由でのアクセスにしか対応していないため、ELBやEC2にWAFを導入する場合はCloudFrontを配置する必要があります。</p>

<p>今回は既に作成済みの「waf-test-acl」にString matchingの設定を追加してみます。<br>
その他の設定については以下参照ください。<br>
<a href="../../../2015/12/28/aws-waf-ipaddress.html">「AWS WAF」を導入してみた。- IP addresses編</a><br>
<a href="../../../2016/01/07/aws-waf-sqlinjection.html">「AWS WAF」を導入してみた。- SQL injection編</a></p>

<h1 id="1.設定">1.設定</h1>

<hr>

<h2 id="①-conditionの作成">① Conditionの作成</h2>

<p>まず、String matchingをクリックします。<br>
<img alt="aws-waf_sql-injection_2015120401.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/3c0e488c-ab1e-ed97-73ef-5f8b66a183ef.png" /></p>

<p>「Create condition」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120402.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/a8744128-6c9f-e323-dc85-8ca16f70d176.png" /></p>

<p>「Name」には任意のコンディション名を入力します。<br>
また、Filter settingsの「Part of the request to filter on」でチェックしたいWeb要求、Match typeは部分一致や完全一致といった条件、「Transformation」でAWS WAFがリクエストをチェックする前に行う変換方式を指定。「Value is base64 encoded」は　「Value to match」にはチェックする文字列を入力します。入力が完了したら最後に「Add another filter」をクリックして条件に追加します。<br>
<img alt="aws-waf_uri_2015121003.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/6a5672a0-c18a-f7b7-ce47-386f319d2a44.png" /></p>

<p>Filters in this string match conditionへの追加が確認できたら「Create」をクリックして作成します。<br>
<img alt="aws-waf_uri_2015121004.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/d5e64543-c90e-30d6-f8a6-18a16bb0080a.png" /></p>

<p><br></p>

<h2 id="②-ruleの作成">② Ruleの作成</h2>

<p>conditionを作成したら、次に「Rules」をクリックします。<br>
<img alt="aws-waf_uri_2015121005.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/1011c8f8-ea24-1b8d-07de-731158892085.png" /></p>

<p>Rules設定画面が表示されたら「Create rule」をクリックしルールの作成を行います。<br>
<img alt="aws-waf_uri_2015121006.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/d38f4d02-4131-0b3e-0068-4c4de905084f.png" /></p>

<p>先ほどConditionsのSQL injectionで作成したルールを設定し、完了したら「Create」をクリックします。<br>
<img alt="aws-waf_uri_2015121007.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/58d87168-f0b6-aea0-8d6f-17e9433e7115.png" /></p>

<p>ルールの作成が完了したら「Web ACLs」をクリックします。<br>
<img alt="aws-waf_uri_2015121008.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/280aa372-ac09-ab3e-dbac-6c65969eec9b.png" /></p>

<p><br></p>

<h2 id="③-access-control-listへの追加">③ Access Control Listへの追加</h2>

<p>今回ルールを追加する対象のACL名をクリックします。<br>
<img alt="aws-waf_uri_2015121009.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/8bc790ec-cbde-dcde-ffe1-f1f0cccf740e.png" /></p>

<p>タブ「Rules」をクリックして「Edit web ACL」をクリックします。<br>
<img alt="aws-waf_uri_2015121010-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/c21cf4c1-f557-80f4-2e82-cc7d0edf7b86.png" /></p>

<p>「Rules」のプルダウンで今回作成したルールを選択し、「Add rule to web ACL」をクリックします。<br>
<img alt="aws-waf_uri_2015121011.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/127306be-910f-092e-fea8-1e4e097b7848.png" /></p>

<p>すると”If a request matches all the conditions in a rule, take the corresponding action”に追加されます。今回はブロックをしたいため”Action”は「Block」をチェックし、「Update」をクリックします。<br>
<img alt="aws-waf_uri_2015121012.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/ed1925ab-f67f-b767-b99b-c5da4222b416.png" /></p>

<p>ルールが追加されました。「Requests」タブをクリックするとリクエストログが確認できます。<br>
<img alt="aws-waf_uri_2015121013-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/21d65f4b-572b-20b3-11d3-c4ce5df9e538.png" /></p>

<p><br>  </p>

<h1 id="2.動作確認">2.動作確認</h1>

<hr>

<p>今回は「test.txt」の文字列があるアクセスはブロックというルールを適用しました。なので例えば「http://<CloudFront>/test.txt」へアクセスすると以下の画面が表示されます。<br>
<img alt="aws-waf_uri_2015121016-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/2e8d2008-6169-9166-c14a-f33ed1a12fad.png" /></p>

<p>今回作成したルールによってフィルタリングがされているかを確認するには「Requests」から今回作成した&quot;uri-string-block-rule&quot;をプルダウンから選び、「Get new samples」をクリックします。<br>
<img alt="aws-waf_uri_2015121015-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/1e536f40-c29a-2e19-4173-959a93b20f44.png" /></p>

<p><br></p>

<h1 id="あとがき">あとがき</h1>

<p>つい先日、画面が変わったみたいです。(とりあえず2015/12/10には変わってました。)<br>
「Requests」タブをクリックすると、マッチしたリクエストまたはルールについてのグラフが現れます。<br>
<img alt="aws-waf_uri_2015121014.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/e4b7a2f3-4a6e-5ddf-e492-3843a25b5708.png" /><br>
　確認したいリクエストやルールにチェックを入れるとそれについてグラフ化されます。もともとCloudWatchで確認できましたが、一つ一つ選択して確認しないといけなかったのと、CloudWatchの画面に移動しないといけなかったので、見やすくなってよかったかなと思います。<br>
　また、「Sampled requests」もルールごとに表示されるように変わりました。これについてはルールごとに表示は見やすくて良いのですが「ALL」みたいな全てを表示する項目があった方がより使いやすいなと感じました。また、以前は記載されていたルールに対しての処理(BlockしたのかAllowしたのか)が無くなってしまったので、そこも直感的に分かりづらくなって残念です。<br>
　ただWAFはリリースしたてというのもあり、今後もどんどん変化していくと思います。よりサービスの充実とともに使いやすくなることにも期待です。</p>
<br /><br><div style="width:74px;height:22px;float:left;"><div style="margin-left:-5px"><a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="proudit_inc" data-lang="ja" data-hashtags="proudblog" data-dnt="true">ツイート</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><div style="width:120px;height:22px;float:left;"><iframe src="//www.facebook.com/v2.0/plugins/like.php?href=http%3A%2F%2Fblog.proudit.jp&amp;width&amp;layout=button&amp;action=like&amp;show_faces=false&amp;share=true&amp;height=90&amp;appId=1679223382318515" scrolling="no" frameborder="0" style="border:none; overflow:hidden; height:90px;" allowTransparency="true"></iframe></div></br><br /><br /></article><aside><fieldset><h2>最近の投稿</h2><ol><li> <i class="fa fa-caret-right"><a href="/2016/03/24/to-update-aws-cli.html">aws-cliのバージョンをアップグレードする。for MacOS</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/03/15/itenoiwai-next.html">移転祝いを頂きました_(2)</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/03/14/jawsdays2016.html">JAWSDAYS2016に参加してきました！</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/03/11/itenosirase.html">移転しました！</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/03/08/to-monitor-the-traffic-using-the-vnstat.html">vnstatで手軽にtrafiicをモニタリング</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/02/29/a-s3bucket-is-allowed-access-only-from-cloudfront.html">S3の特定バケットへのアクセスを特定のCloudFrontからのみ許可する。</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/02/22/how-to-use-lsof.html">lsofを使ってプロセスが利用しているポートを確認する。</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/02/15/comfirm-a-version-of-redmine.html">Redmineのバージョンを確認する。</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/02/14/jawsdays2016-workshop-speker.html">Jawsdays2016 ハンズオンブースのスピーカーやります！</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/02/09/connect-github-to-circleci.html">GitHubとCircleCIを連携させよう！！</a></i></li></ol></fieldset><fieldset><h2>投稿者</h2><ol><li> <i class="fa fa-pencil"><a href="/toguma.html">toguma</a></i></li><li> <i class="fa fa-pencil"><a href="/kohei.html">kohei</a></i></li><li> <i class="fa fa-pencil"><a href="/proudcloud.html">proudcloud</a></i></li></ol></fieldset><fieldset><h2>タグ</h2><ol><li> <i class="fa fa-tag"><a href="/tags/aws.html">AWS (8)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/github.html">GitHub (5)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/circleci.html">CircleCI (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/s3.html">S3 (3)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/lambda.html">lambda (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/cognito.html">cognito (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/waf.html">WAF (3)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/cloudfront.html">CloudFront (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/redmine.html">Redmine (2)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/amazonlinux.html">AmazonLinux (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/ec2.html">EC2 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/mocloud.html">moCloud (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/hubot.html">Hubot (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/slack.html">Slack (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/jawsdays2016.html">jawsdays2016 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/linux.html">Linux (2)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vnstat.html">vnstat (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vnstati.html">vnstati (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/お知らせ.html">お知らせ (3)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/jawsdays.html">JAWSDAYS (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/aws-cli.html">aws-cli (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/macos.html">MacOS (1)</a></i></li></ol></fieldset><fieldset><h2>アーカイブ</h2><ol><li> <i class="fa fa-calendar"><a href="/2016.html">2016 (15)</a></i></li><li> <i class="fa fa-calendar"><a href="/2015.html">2015 (3)</a></i></li></ol></fieldset></aside></div><footer><p><i class="fa fa-copyright"></i> <a href="/">Proud Blog</a> - Powerd by <a href="http://www.proudit.jp/">Proudit Inc.</a></p></footer></body></html>